name: Deploy to Render

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ secrets.RENDER_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pre-deployment checks
      env:
        DATABASE_URL: sqlite:///./test.db
        SECRET_KEY: test-secret-key
        ALGORITHM: HS256
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
        ENVIRONMENT: development
        CORS_ORIGINS: http://localhost:3000
        ENABLE_RATE_LIMITING: False
      run: |
        # Check Alembic migrations are valid
        alembic check || echo "::warning::Alembic migrations may have issues"

        # Verify critical files exist
        test -f app/main.py || exit 1
        test -f requirements.txt || exit 1
        test -f alembic.ini || exit 1

        echo "âœ… Pre-deployment checks passed"

    - name: Trigger Render deployment
      if: success()
      run: |
        echo "Triggering Render deployment via deploy hook..."

        # Render automatically deploys on push to main branch
        # If using Render Deploy Hook (manual trigger):
        if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "âœ… Render deployment triggered"
        else
          echo "â„¹ï¸ Render will auto-deploy from main branch push"
        fi

    - name: Wait for deployment (optional)
      if: success() && secrets.RENDER_API_KEY != ''
      run: |
        echo "Waiting for Render deployment to complete..."
        sleep 30
        # Add Render API polling logic here if needed
        echo "â³ Deployment in progress on Render..."

    - name: Post-deployment health check
      if: success()
      run: |
        echo "Waiting for service to be ready..."
        sleep 60

        # Health check (replace with your actual Render URL)
        RENDER_URL="${{ secrets.RENDER_URL }}"
        if [ -n "$RENDER_URL" ]; then
          for i in {1..5}; do
            if curl -f -s "$RENDER_URL/health" > /dev/null; then
              echo "âœ… Health check passed!"
              curl -s "$RENDER_URL/health"
              break
            else
              echo "â³ Attempt $i/5: Service not ready yet, waiting..."
              sleep 20
            fi
          done
        else
          echo "âš ï¸ RENDER_URL not configured, skipping health check"
        fi

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment to Render completed successfully!"
          echo "ðŸš€ Application is live at: ${{ secrets.RENDER_URL }}"
        else
          echo "âŒ Deployment failed. Check logs above."
        fi

    - name: Create deployment summary
      if: always()
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -n "${{ secrets.RENDER_URL }}" ]; then
          echo "**Live URL**: [${{ secrets.RENDER_URL }}](${{ secrets.RENDER_URL }})" >> $GITHUB_STEP_SUMMARY
        fi

  database-backup:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
    - name: Trigger database backup (optional)
      run: |
        echo "â„¹ï¸ Database backup should be configured in Render Dashboard"
        echo "Render PostgreSQL includes automatic daily backups"
        echo "Manual backups can be triggered from Render Dashboard > Database > Backups"

  rollback:
    runs-on: ubuntu-latest
    if: failure()

    steps:
    - name: Rollback instructions
      run: |
        echo "âŒ Deployment failed!"
        echo ""
        echo "To rollback manually:"
        echo "1. Go to Render Dashboard > Your Service"
        echo "2. Click 'Events' tab"
        echo "3. Find the last successful deployment"
        echo "4. Click 'Redeploy' on that commit"
        echo ""
        echo "Or use Render CLI:"
        echo "  render services rollback <service-id> --to <deployment-id>"
